"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ResourceObj=void 0;const rxjs_1=require("rxjs");class ResourceObj{constructor(e,t,s,i){if(this.can=e,this.name=t,this.config=i,this._promise=!1,this.computed=!1,this.__value=void 0,"value"===this.type){if(null!=(e=i.deps)&&e.length)throw new Error("value properties cannot have dependencies "+t);this.isComputeOnce&&console.warn(t,": computeOnce has no effect on value entries -- did you mean to set final?")}this.resource=s,"func"===this.type&&(this._value=this.calculator),"comp"===this.type&&this.listenForValue()}calcComp(){this.isComputeOnce&&this.computed?console.warn("attempt to re-compute",this.name):this.config.async?this.calculator().then(e=>{this._value=e,this.computed=!0}):(this._value=this.calculator(),this.computed=!0)}listenForValue(){const t=this;var e=this.hasDeps?[...this.config.deps]:[];e.length?this.config.computeOnce?this._computeSub=this.can.observe(e).pipe((0,rxjs_1.first)()).subscribe(()=>{console.log("--- computing once with resource",this._resource.toString()),this.calcComp()}):this._computeSub=this.can.observe(e).pipe((0,rxjs_1.switchMap)(e=>(this.config.async?(0,rxjs_1.from):(0,rxjs_1.of))(this.calculator()))).subscribe({next(e){t._value=e,t.computed=!0}}):this.calcComp()}get hasDeps(){var e;return!(null==(e=this.config.deps)||!e.length)}get resource(){return this._resource}set resource(e){if(this.isFinal&&this.added)throw new Error("cannot change resource "+this.name);if(("comp"===this.type||"func"===this.type)&&"function"!=typeof e)throw new Error(`attempt to pass a non-functional value to ${this.name} (type ${this.type})`);switch(this._resource=e,this.added=Date.now(),this.type){case"comp":this.isComputeOnce&&this.computed||!this._computeSub||(this._computeSub.unsubscribe(),this.listenForValue());break;case"func":break;case"value":this.config.async&&(this._promise=!0,this._resource.then(()=>{this._promise=!1}))}}get pending(){var e;return!!this._promise||!(null==(e=this.config.deps)||!e.length)&&"comp"===this.type&&this.config.async&&!this.computed}get _value(){return this.__value}set _value(e){this.__value=e}get type(){return this.config.type}get isFinal(){return!!this.config.final}get isComputeOnce(){return!!this.config.computeOnce}get deps(){var e;return null!=(e=this.config.deps)&&e.length?this.can.has(this.config.deps)?this.can.value(this.config.deps):this.config.deps.map(()=>{}):[]}get args(){return this.config.args||[]}get calculator(){return(...e)=>{e=[...this.deps,...this.args,...e];return this.resource(...e)}}get value(){if(!this.pending)return"value"===this.type?this.resource:this._value;console.log(this.name,"pending - not returning value")}invalidateOnAddition(){if(!this._computeSub){const t=this;var e=null!=(e=this.config.deps)&&e.length?this.can.loadStream.pipe((0,rxjs_1.filter)(e=>(this.config.deps||[]).includes(e))):this.can.loadStream;this._computeSub=e.subscribe({next:()=>t.computed=!1,error(){var e;null!=(e=t._computeSub)&&e.unsubscribe()},complete(){var e;null!=(e=t._computeSub)&&e.unsubscribe()}})}}}exports.ResourceObj=ResourceObj;