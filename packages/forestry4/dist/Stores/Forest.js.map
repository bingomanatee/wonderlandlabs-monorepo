{"version":3,"file":"Forest.js","sources":["../../src/Stores/Forest.ts"],"sourcesContent":["import { Store } from './Store';\nimport {\n  ActionExposedRecord,\n  Path,\n  StoreParams,\n  StoreBranch,\n  ForestMessage,\n  BranchParams,\n} from '../types';\nimport { Subject } from 'rxjs';\nimport { pathString } from '../lib/combinePaths';\nimport { produce } from 'immer';\nimport { ForestBranch } from './ForestBranch';\nimport { setPath, getPath } from '../lib/path';\n\nexport class Forest<DataType, Actions extends ActionExposedRecord = ActionExposedRecord>\n  extends Store<DataType, Actions>\n  implements StoreBranch<DataType, Actions>\n{\n  constructor(p: StoreParams<DataType, Actions>) {\n    super(p);\n  }\n\n  path: Path = [];\n  parent?: StoreBranch<unknown> = null;\n  isRoot = true;\n\n  get root() {\n    return this;\n  }\n\n  public broadcast(message: unknown, fromRoot?: boolean) {\n    if (fromRoot || this.isRoot) {\n      this.receiver.next(message);\n    }\n    if (this.parent) {\n      this.parent.broadcast(message);\n    }\n  }\n\n  public receiver = new Subject();\n\n  // Override complete to handle forest-wide completion\n  complete(): DataType {\n    if (!this.isActive) {\n      return this.value;\n    }\n\n    // Send completion message to all branches before completing\n    const completionMessage: ForestMessage = {\n      type: 'complete',\n      timestamp: Date.now(),\n    };\n    this.broadcast(completionMessage, true);\n\n    // Complete the receiver subject\n    this.receiver.complete();\n\n    // Call parent complete method\n    return super.complete();\n  }\n\n  // Override next to implement validation messaging system\n  next(value: Partial<DataType>): boolean {\n    // Prevent concurrent validation\n    if (this.hasPending()) {\n      throw new Error('Cannot start new validation while another validation is in progress');\n    }\n\n    // Apply prep function if it exists to transform partial input to complete data\n    const preparedValue = this.prep\n      ? this.prep(value, this.value, this.initialValue)\n      : (value as DataType);\n\n    // First validate using Store's validation\n    const { isValid, error } = this.validate(preparedValue);\n    if (!isValid) {\n      if (this.debug) {\n        console.error(\n          'cannot update ',\n          this.name,\n          'with',\n          preparedValue,\n          '(current: ',\n          this.value,\n          ')',\n          error\n        );\n      }\n      throw new Error(typeof error === 'string' ? error : error?.toString() || 'Validation failed');\n    }\n\n    this.setPending(preparedValue);\n\n    try {\n      // Step 1: Create transient listener for validation failures\n      let validationError: string | null = null;\n      const transientSub = this.receiver.subscribe((message: any) => {\n        if (message && message.type === 'validation-failure') {\n          validationError = `Branch ${pathString(message.branchPath)}: ${message.error}`;\n        }\n      });\n\n      try {\n        // Step 2: Send setPending message to all branches\n        const setPendingMessage: ForestMessage = {\n          type: 'set-pending',\n          payload: preparedValue,\n          timestamp: Date.now(),\n        };\n        this.broadcast(setPendingMessage, true);\n\n        // Step 3: Send validate message to trigger validation\n        const validateMessage: ForestMessage = {\n          type: 'validate-all',\n          timestamp: Date.now(),\n        };\n        this.broadcast(validateMessage, true);\n\n        // Step 4: Check if any validation failure was received\n        if (validationError) {\n          if (this.debug) {\n            console.error('Branch validation failed:', validationError);\n          }\n          throw new Error(`Validation failed: ${validationError}`);\n        }\n\n        // Step 5: All validations passed, call super.next()\n        return super.next(preparedValue);\n      } finally {\n        // Clean up transient subscription\n        transientSub.unsubscribe();\n      }\n    } finally {\n      this.clearPending();\n    }\n  }\n\n  set(path: Path, value: unknown): boolean {\n    const pathArray = Array.isArray(path) ? path : pathString(path).split('.');\n    const newValue = produce(this.value, (draft) => {\n      // Use Immer to safely set nested values\n      setPath(draft, pathArray, value);\n    });\n    return this.next(newValue);\n  }\n\n  branch<Type, BranchActions extends ActionExposedRecord = ActionExposedRecord>(\n    path: Path,\n    params: BranchParams<Type, BranchActions>\n  ) {\n    const name = this.name + '.' + pathString(path);\n    return new ForestBranch<Type, BranchActions>(\n      {\n        name,\n        ...params,\n      },\n      path,\n      this\n    );\n  }\n}\n"],"names":[],"mappings":"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"}