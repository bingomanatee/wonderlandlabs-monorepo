"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const Branch_1=__importDefault(require("./Branch")),Trans_1=require("./Trans"),helpers_1=require("./helpers");class Forest{items=new Map;register(e){this.items.set(e.forestId,e)}createBranch(e,r){if(r)return this.createBranch({...e,name:r});if((0,helpers_1.isBranchConfig)(e))return r=new Branch_1.default(e,this),this.register(r),r;throw console.warn("bad configuration",e),new Error("bad configuration")}pending=[];trans(r,e){r=new Trans_1.Trans({name:r,forest:this});this.pending.push(r);try{e(r),this.removeTrans(r),this.pending.length<=0&&this.commit()}catch(e){throw r.fail(e),e}}removeTrans(r){var e,t=this.pending.findIndex(e=>e.id===r.id);0<=t&&(e=this.pending.slice(t),this.pending=this.pending.slice(0,t),e.forEach(e=>{}))}commit(){this.items.forEach(e=>{e.commit()}),this.items.forEach(e=>e.flushTemp())}}exports.default=Forest;