var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Forest=void 0;let Tree_1=__importDefault(require("./Tree")),rxjs_1=require("rxjs");class Forest{constructor(){this.trees=new Map,this._time=0,this.depth=new rxjs_1.BehaviorSubject(new Set)}hasTree(e){return this.trees.has(e)}tree(e){if(this.hasTree(e))return this.trees.get(e)}addTree(e,t){if(this.hasTree(e))throw new Error("cannot redefine tree "+e);t=new Tree_1.default(this,e,t);return this.trees.set(e,t),t}get nextTime(){var e=this._time+1;return this._time=e}do(e){let r=this.nextTime;var t=new Set(this.depth.value);t.add(r),this.depth.next(t);try{return e(this)}catch(t){throw this.trees.forEach(e=>{e.rollback(r,t instanceof Error?t.message:"unknown error")}),t}t=new Set(this.depth.value);t.delete(r),this.depth.next(t)}}exports.Forest=Forest;