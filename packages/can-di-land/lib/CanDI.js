"use strict";var __awaiter=this&&this.__awaiter||function(r,n,o,u){return new(o=o||Promise)(function(t,e){function s(r){try{a(u.next(r))}catch(r){e(r)}}function i(r){try{a(u.throw(r))}catch(r){e(r)}}function a(r){var e;r.done?t(r.value):((e=r.value)instanceof o?e:new o(function(r){r(e)})).then(s,i)}a((u=u.apply(r,n||[])).next())})};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CanDI=void 0;const rxjs_1=require("rxjs"),ResourceObj_1=require("./ResourceObj");class CanDI{constructor(r){this.registry=new Map,this.loadStream=new rxjs_1.Subject,null!=r&&r.forEach(r=>{var e=r.value,t=r.config||r.type;t&&this.set(r.name,e,t)})}set(r,e,t){if(this.registry.has(r))this.registry.get(r).resource=e;else{if(t?"string"==typeof t&&(t={type:t}):t={type:"value"},!["comp","func","value"].includes(t.type))throw new Error("unknown type  for "+r+": "+t.type);this.registry.set(r,new ResourceObj_1.ResourceObj(this,r,e,t))}return this.loadStream.next(r),this}get(r,e){return __awaiter(this,void 0,void 0,function*(){return this.has(r)?this.value(r):(0,rxjs_1.firstValueFrom)(this.when(r,e))})}value(r){try{var e;return Array.isArray(r)?r.map(r=>this.value(r)):!this.registry.has(r)||(e=this.registry.get(r)).pending?void 0:e.value}catch(r){console.log("---- value error:",r)}}has(r){return Array.isArray(r)?r.every(r=>this.has(r)):!!this.registry.has(r)&&!this.registry.get(r).pending}when(e,r=0){return void 0!==r&&0<=r?this.observe(e).pipe((0,rxjs_1.first)(),(0,rxjs_1.timeout)(r+1),(0,rxjs_1.map)(r=>Array.isArray(e)?r:r[0])):this.observe(e).pipe((0,rxjs_1.first)(),(0,rxjs_1.map)(r=>Array.isArray(e)?r:r[0]))}observe(r){const e=Array.isArray(r)?r:[r];return this.loadStream.pipe((0,rxjs_1.filter)(r=>e.includes(r)),(0,rxjs_1.filter)(()=>this.has(e)),(0,rxjs_1.map)(()=>this.value(e)))}}exports.CanDI=CanDI;